#!/usr/bin/env bash

set -e

# Get the directory of this script (even if the script is called through a symlink)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ] ; do SOURCE="$(readlink "$SOURCE")"; done
MOODLE_DOCKER_BINDIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

MOODLE_DOCKER_DIR=$(realpath $(dirname $MOODLE_DOCKER_BINDIR))

# Check that the config.docker-template.php exists in the directory
if [ ! -r "$MOODLE_DOCKER_DIR/config.docker-template.php" ]; then
    >&2 echo 'Error: $MOODLE_DOCKER_DIR could not be determined to be an existing directory'
    exit 1
fi

export MOODLE_DOCKER_WWWROOT=`pwd`

if [ ! -r "$MOODLE_DOCKER_WWWROOT/config-dist.php" ]; then
    >&2 echo 'Error: ./config-dist.php is not present; are you running this from a Moodle directory?'
    exit 1
fi

# Personal settings.
if [ -r "$HOME/.moodle-compose.env" ]; then
    . $HOME/.moodle-compose.env
fi

# Moodle instance settings
if [ -r "$MOODLE_DOCKER_WWWROOT/projectinfo.yml" ]; then
    MOODLE_CODENAME=$(grep -e  '^codename' "$MOODLE_DOCKER_WWWROOT/projectinfo.yml" | awk -F ': ' '{print $2}')
fi

if [ -z "${MOODLE_CODENAME}" ]; then
    >&2 echo 'Error: $MOODLE_CODENAME not set'
    >&2 echo '       It should be set either in:'
    >&2 echo '        - the environment (export MOODLE_CODENAME=)'
    >&2 echo '        - projectinfo.yml (codename:)'
    exit 1
fi

export MOODLE_CODENAME=${MOODLE_CODENAME}

# Related to Moodle
export MOODLE_DOCKER_DB=${MOODLE_DOCKER_DB:-pgsql}
export MOODLE_DOCKER_PHP_VERSION=${MOODLE_DOCKER_PHP_VERSION:-7.2}

# Related to one's local setup
export MOODLE_DOCKER_NETWORK=${MOODLE_DOCKER_NETWORK:-docker.test}
export MOODLE_DOCKER_WEB_HOST=${MOODLE_DOCKER_WEB_HOST:-${MOODLE_CODENAME}.${MOODLE_DOCKER_NETWORK}}
export MOODLE_DOCKER_TRAEFIK=${MOODLE_DOCKER_NO_TRAEFIK:-enable}
export MOODLE_DOCKER_TRAEFIK_HTTPS=${MOODLE_DOCKER_TRAEFIK_HTTP_ONLY:-true}

export COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-${MOODLE_CODENAME}}

# Force-copy the most recent config.php
if ! [ -r ./config.php ] || ! diff -q $MOODLE_DOCKER_DIR/config.docker-template.php ./config.php; then
    rm -f ./config.php
    cp $MOODLE_DOCKER_DIR/config.docker-template.php ./config.php
fi

ARGS=
dump=

if [ -n "$1" ]; then
    case $1 in
    install|i)
        #Â Standard local installation
        ARGS="exec webserver php admin/cli/install_database.php"
        ARGS="$ARGS --agree-license"
        ARGS="$ARGS --fullname=${MOODLE_CODENAME}"
        ARGS="$ARGS --shortname=${MOODLE_CODENAME}"
        ARGS="$ARGS --adminemail=admin@${MOODLE_DOCKER_WEB_HOST}"
        ARGS="$ARGS --adminuser=admin"
        ARGS="$ARGS --adminpass=adminadmin"
        shift 1
        ;;
    upgrade|u)
        ARGS="exec webserver php admin/cli/upgrade.php"
        ARGS="$ARGS --non-interactive"
        shift 1
        ;;
    purge_caches|pc)
        ARGS="exec webserver php admin/cli/purge_caches.php"
        shift 1
        ;;
    adhoc_tasks|at)
        ARGS="exec webserver php admin/tool/task/cli/adhoc_task.php --execute"
        shift 1
        ;;
    cron|c)
        ARGS="exec webserver php admin/cli/cron.php"
        shift 1
        ;;
    pgrestore|pgr)
        if [ -z $2  ]; then
	        echo "Insert the name of the pgdump file: "
	        read dump
        else
	        dump=$2
        fi
        clear
        printf "\n>>> Copying the pgdump file to the ${MOODLE_CODENAME}_db_1  volume\n------------------------------------------------------\n"
        # It depends on Python, but who does not have it this days?
        destination_folder=$(docker inspect -f '{{ json .Mounts }}' ${MOODLE_CODENAME}_db_1 | python -m json.tool | grep Destination | cut -d':' -f2 | cut -d'"' -f2)
        date=$(date +%Y%m%d)
        filename=${destination_folder}/${MOODLE_CODENAME}.${date}.${dump}
        printf "${filename}\n"
        docker cp ${dump} ${MOODLE_CODENAME}_db_1:${filename}
        printf "\n>>> Removing the moodle DB\n--------------------------\n"
        docker exec -t ${MOODLE_CODENAME}_db_1 /usr/bin/dropdb -e -U moodle moodle
        printf "\n>>> Recreating the DB moodle from template0\n-------------------------------------------\n"
        docker exec -t ${MOODLE_CODENAME}_db_1 /usr/bin/createdb -e -U moodle --template=template0 --owner=moodle moodle
        printf "\n>>> Restoring the moodle DB with the pgdump file (Chill for a while)\n--------------------------------------------------------------------\n"
        docker exec ${MOODLE_CODENAME}_db_1 /usr/bin/pg_restore -U moodle -d moodle --no-owner ${filename} && echo ""
        printf "\n>>> DB restored! Removing the pgdump file...\n"
        docker exec ${MOODLE_CODENAME}_db_1 rm ${filename}
        printf "\n>>> Updating moodle DB\n----------------------\n"
        moodle-compose u
        printf "\n>>> Purging the Moodle cache\n----------------------------\n"
        moodle-compose pc
        printf "\nMoodle is ready => http://${MOODLE_CODENAME}.docker.test\n"
        exit 1
        ;;
    esac
fi
$MOODLE_DOCKER_DIR/bin/moodle-docker-compose $ARGS "$@"
